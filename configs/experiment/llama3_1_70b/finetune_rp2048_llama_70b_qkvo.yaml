dataset:
  name: redpajama_sample_contig
  dataset_config:
    train_data: 
    - redpajama/train.json[50000]
    eval_data:
    - redpajama/train.json
    num_train_samples: 10000  # (8 * 1250) * (2048) = 20M
    max_train_samples: 40000
    max_eval_num: 1000
    max_length: 32768
    min_length: 2048
    chat_template: llama-3
    chunk_size: 2048  # sequence length for distilling
    seed: 42
    cache_dir: "data/rp"  # Change this to where you want to save
    load_from_cache_file: true
    esl_model_config: llama3_1_70b/distill_llama3_1_70b_lk_smd_wtk64_fd64_w01
    filter_by_esl: true
    dataloaders_dir: '/home/rahul/code/clean/lolcats/src/dataloaders'
  pretrained_model_config:
    pretrained_model_name_or_path: "/data/rahul/models/Meta-Llama-3.1-70B/"
    cache_dir: null
  preprocess_config: null

dataloader:
  batch_size: 1
  num_workers: 2
  drop_last: false
  pin_memory: true

optimizer:
  optim: adamw_torch_fused
  lr: 1e-4
  weight_decay: 0.0

lr_scheduler:
  lr_scheduler_type: reduce_lr_on_plateau
  mode: min
  factor: 0.1
  patience: 10
  min_lr: 0.00001

trainer: # HuggingFace Trainer-like arguments
  name: default_lm
  bf16: true
  train_split: train
  val_split: validation
  num_train_epochs: 2
  gradient_accumulation_steps: 2
  seed: 42
  batch_size: 1
  load_best_model_at_end: true
  greater_is_better: false
  metric_for_best_model: eval/loss # eval/rouge/geometric_mean
  logging_steps: 100
  evaluation_strategy: steps
  max_steps: -1
  eval_steps: 5  # 10
  max_eval_batches: null

finetune:
  method: lora
  kwargs:
    r: 4
    lora_alpha: 8
    lora_dropout: 0.05
    target_modules: ["q_proj", "k_proj", "v_proj", "o_proj"]

fsdp:
  save_model: true 
  run_validation: true
  use_fp16: false
  save_optimizer: false
  gradient_clipping: true  # false
  gradient_clipping_threshold: 1.0
